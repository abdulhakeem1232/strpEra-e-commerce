<!DOCTYPE html>
<html lang="zxx" class="no-js">

<head>
    <!-- Mobile Specific Meta -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Favicon-->
    <link rel="shortcut icon" href="img/fav.png">
    <!-- Author Meta -->
    <meta name="author" content="CodePixar">
    <!-- Meta Description -->
    <meta name="description" content="">
    <!-- Meta Keyword -->
    <meta name="keywords" content="">
    <!-- meta character set -->
    <meta charset="UTF-8">
    <!-- Site Title -->
    <title>Karma Shop</title> 
    <!--
		CSS
		============================================= -->
    <link rel="stylesheet" href="/css/linearicons.css">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/themify-icons.css">
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/css/owl.carousel.css">
    <link rel="stylesheet" href="/css/nice-select.css">
    <link rel="stylesheet" href="/css/nouislider.min.css">
    <link rel="stylesheet" href="/css/ion.rangeSlider.css" />
    <link rel="stylesheet" href="/css/ion.rangeSlider.skinFlat.css" />
    <link rel="stylesheet" href="/css/magnific-popup.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/admin_assets/assets/css/magiczoom.css">
    <script src="/admin_assets/assets/js/magiczoom.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
<style>
    
</style>

</head>

<body>

    <!-- Start Header Area -->
    <%- include('partials/nav')%>
        <!-- End Header Area -->
        <!-- Start Banner Section -->
        <section class="banner-area organic-breadcrumb">
            <div class="container">
                <div class="breadcrumb-banner d-flex flex-wrap align-items-center justify-content-end">
                    <div class="col-first">
                        <h1>Shopping</h1>
                        <nav class="d-flex align-items-center">
                            <a href="#">Home<span class="lnr lnr-arrow-right"></span></a>
                            <a href="#">Checkout</a>
                        </nav>
                    </div>
                </div>
            </div>
        </section>


        
        <div class="container mt-5">
            <h1 class="mb-4">Order History</h1>
        
            <% if (orders.length === 0) { %>
                <p>No orders found.</p>
            <% } else { %>
                <ul class="list-group">
                    <% orders.forEach(order => { %>
                        <li class="list-group-item mb-3">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h5>Order ID: <%= order.orderId %></h5>
                                    <p>Amount: â‚¹<%= order.amount %></p>
                                    <p>Status: <%= order.status %></p>
                                    <p>Delivery Address: <%= order.address[0].save_as %>, <%= order.address[0].houseName %>, <%= order.address[0].city %>, <%= order.address[0].pincode %></p>
                                </div>
                                <div>
                                    <% if (order.status !== 'Cancelled' && order.status !== 'delivered') { %>
                                        <a href="/cancelorder/<%= order._id %>"> Cancel</a>
                                    <% } %>
        
                                    <% if (order.status == 'delivered' && new Date(order.updated.getTime() + 5 * 24 * 60 * 60 * 1000) >= new Date()) { %>
                                        <a href="/returnorder/<%= order._id %>"> Return</a>
                                    <% } %>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-group">
                                        <% order.items.forEach(item => { %>
                                            <li class="list-group-item">
                                                <img src="/<%= item.productId.images[0] %>" alt="" style="height: 100px; width: 100px;">
                                                <p>Product Name: <%= item.productId.name %></p>
                                                <p>Quantity: <%= item.quantity %></p>
                                            </li>
                                        <% }); %>
                                    </ul>
                                </div>
                                <div class="col-md-6">
                                    <% if (order.status === 'delivered' || order.status === 'returned') { %>
                                        <% order.items.forEach(item => { %>
                                            <% if (item.productId.ratings.some(rating => rating.orderId == order.orderId && rating.productId == item.productId)) { %>
                                           <div>
                                            hii
                                           </div>
                                            <% } else { %>
                                                <form action="/addRatings" method="post">
                                                    <div class="form-group">
                                                        <label for="rating_<%= item.productId._id %>">Rating for <%= item.productId.name %>:</label>
                                                        <div class="star-rating" data-rating="<%= item.rating || 0 %>" data-product-id="<%= item.productId._id %>">
                                                            <% for (let i = 1; i <= 5; i++) { %>
                                                                <span class="fa fa-star" data-star-value="<%= i %>"></span>
                                                            <% } %>
                                                        </div>
                                                        <input type="hidden" name="orderId" id="orderId" value="<%= order.orderId %>">
                                                        <input type="hidden" name="productId" id="productId" value="<%= item.productId._id %>">
                                                        <input type="hidden" name="rating" id="rating" value="0">
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="review_<%= item.productId._id %>">Review for <%= item.productId.name %>:</label>
                                                        <textarea class="form-control" id="review_<%= item.productId._id %>" name="review" rows="3"></textarea>
                                                    </div>
                                                    <button type="submit" class="btn btn-primary">Submit Review</button>
                                                </form>
                                            <% } %>
                                        <% }); %>
                                    <% } %>
                                </div>
                            </div>
                            <div class="mt-1">
                                <a href="/order-tracking/<%= order._id %>"> Order Details</a>
                            </div>
                            </li>
                            <% }); %>
                            </ul>
                            <% } %>
                            </div>
                            
        
        
	
	

        <%- include('partials/footer')%>
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const starContainers = document.querySelectorAll('.star-rating');
        
                starContainers.forEach(container => {
                    const stars = container.querySelectorAll('.fa-star');
        
                    stars.forEach(star => {
                        star.addEventListener('click', function () {
                            const rating = parseInt(this.getAttribute('data-star-value'));
                            const productId = container.getAttribute('data-product-id');
                            setRating(productId, rating);
        
                           
                            stars.forEach(s => s.classList.remove('selected'));
        
                            
                            for (let i = 1; i <= rating; i++) {
                                stars[i - 1].classList.add('selected');
                            }
                            document.getElementById('rating').value=rating;
                        });
                    });
                });
        
                function setRating(productId, rating) {
                   
                    console.log(`Product ID: ${productId}, Rating: ${rating}`);
                }
            });
        </script>
        
        <style>
            .fa-star.selected {
                color: gold;
            }
        </style>
        
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
            <script src="/public/user_assets/js/vendor/jquery-2.2.4.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
                integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
                crossorigin="anonymous"></script>
            <script src="/public/user_assets/js/vendor/bootstrap.min.js"></script>
            <script src="/public/user_assets/js/jquery.ajaxchimp.min.js"></script>
            <script src="/public/user_assets/js/jquery.nice-select.min.js"></script>
            <script src="/public/user_assets/js/jquery.sticky.js"></script>
            <script src="/public/user_assets/js/nouislider.min.js"></script>
            <script src="/public/user_assets/js/countdown.js"></script>
            <script src="/public/user_assets/js/jquery.magnific-popup.min.js"></script>
            <script src="/public/user_assets/js/owl.carousel.min.js"></script>
            <!--gmaps Js-->
            <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCjCGmQ0Uq4exrzdcL6rvxywDDOvfAu6eE"></script>
            <script src="/public/user_assets/js/gmaps.min.js"></script>
            <script src="/public/user_assets/js/main.js"></script>

</body>

</html>